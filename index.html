async function showDetailedActivityMap(activityId) {
    try {
        // Aktivite streams verisini al
        const streamsResponse = await fetch(
            `https://www.strava.com/api/v3/activities/${activityId}/streams?keys=latlng,altitude,cadence&key_by_type=true`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
        const streams = await streamsResponse.json();
        
        const mapDiv = document.getElementById('activityMap');
        mapDiv.innerHTML = '';
        
        // Info panel oluştur
        const infoPanel = document.createElement('div');
        infoPanel.id = 'mapInfoPanel';
        infoPanel.className = 'absolute bottom-4 left-4 bg-white p-3 rounded-lg shadow-lg z-[1000] pointer-events-none';
        mapDiv.appendChild(infoPanel);
        
        // Haritayı başlat
        if (currentMap) {
            currentMap.remove();
        }
        
        currentMap = L.map(mapDiv);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(currentMap);

        // Rota verilerini hazırla
        const coordinates = streams.latlng.data;
        const elevations = streams.altitude.data;
        const cadences = streams.cadence ? streams.cadence.data : null;
        
        // Rota çizgisini oluştur
        const routePoints = coordinates.map((coord, index) => ({
            latlng: L.latLng(coord[0], coord[1]),
            elevation: elevations[index],
            cadence: cadences ? cadences[index] : null
        }));

        // Gradient renklerini hesapla
        const minElevation = Math.min(...elevations);
        const maxElevation = Math.max(...elevations);
        
        // Rota segmentlerini oluştur
        for (let i = 0; i < routePoints.length - 1; i++) {
            const segment = L.polyline(
                [routePoints[i].latlng, routePoints[i + 1].latlng],
                {
                    color: getElevationColor(routePoints[i].elevation, minElevation, maxElevation),
                    weight: 4
                }
            ).addTo(currentMap);

            // Her segment için hover olayı
            segment.on('mouseover', (e) => {
                const point = routePoints[i];
                updateInfoPanel(point.elevation, point.cadence);
                segment.setStyle({ weight: 6 });
            });

            segment.on('mouseout', () => {
                segment.setStyle({ weight: 4 });
            });
        }

        // Haritayı rota sınırlarına göre ayarla
        currentMap.fitBounds(L.latLngBounds(coordinates.map(coord => L.latLng(coord[0], coord[1]))));
        
        // Renk ölçeği ekle
        addElevationLegend(currentMap, minElevation, maxElevation);
        
    } catch (error) {
        console.error('Detaylı harita gösterilirken hata:', error);
        mapDiv.innerHTML = 'Harita yüklenirken bir hata oluştu. Lütfen tekrar deneyin.';
    }
}

function updateInfoPanel(elevation, cadence) {
    const panel = document.getElementById('mapInfoPanel');
    panel.innerHTML = `
        <div class="text-sm">
            <div class="font-semibold">Yükseklik: ${elevation.toFixed(1)}m</div>
            ${cadence ? `<div class="font-semibold">Kadans: ${cadence} rpm</div>` : ''}
        </div>
    `;
}

function getElevationColor(elevation, min, max) {
    // Yüksekliğe göre renk gradyanı oluştur
    const percentage = (elevation - min) / (max - min);
    // Yeşilden kırmızıya gradyan
    const hue = ((1 - percentage) * 120).toString(10);
    return `hsl(${hue}, 70%, 50%)`;
}

function addElevationLegend(map, min, max) {
    const legend = L.control({ position: 'bottomright' });
    
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'info legend bg-white p-2 rounded-lg shadow-lg');
        div.innerHTML = `
            <div class="text-xs font-semibold mb-1">Yükseklik</div>
            <div style="background: linear-gradient(to bottom, hsl(0, 70%, 50%), hsl(120, 70%, 50%)); width: 20px; height: 100px; display: inline-block;"></div>
            <div class="text-xs">
                <div>${max.toFixed(0)}m</div>
                <div>${min.toFixed(0)}m</div>
            </div>
        `;
        return div;
    };
    
    legend.addTo(map);
}

// showActivityDetails fonksiyonunu güncelle
async function showActivityDetails(activityId) {
    // ... (mevcut kod) ...
    
    // Harita gösterme kısmını değiştir
    if (activity.map?.summary_polyline) {
        setTimeout(() => {
            showDetailedActivityMap(activityId);
        }, 100);
    }
    
    // ... (mevcut kod) ...
}
