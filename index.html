// showActivityDetails fonksiyonunu güncelliyoruz
async function showActivityDetails(activityId) {
    const modal = document.getElementById('activityModal');
    const mapDiv = document.getElementById('activityMap');
    const statsDiv = document.getElementById('activityStats');
    
    modal.classList.remove('hidden');
    mapDiv.innerHTML = 'Harita yükleniyor...';
    statsDiv.innerHTML = 'Veriler yükleniyor...';

    try {
        // Ana aktivite verilerini al
        const activityResponse = await fetch(
            `https://www.strava.com/api/v3/activities/${activityId}?include_all_efforts=true`,
            {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            }
        );
        const activity = await activityResponse.json();

        // Stream verilerini al (kadans, eğim, yükseklik)
        const streamsResponse = await fetch(
            `https://www.strava.com/api/v3/activities/${activityId}/streams?keys=time,latlng,altitude,cadence,grade_smooth&key_by_type=true`,
            {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            }
        );
        const streams = await streamsResponse.json();

        // İstatistikleri göster
        displayActivityStats(activity, streams);

        // Haritayı göster
        if (streams.latlng?.data) {
            initializeEnhancedMap(mapDiv, activity, streams);
        } else {
            mapDiv.innerHTML = 'Bu aktivite için harita verisi bulunmuyor.';
        }

    } catch (error) {
        console.error('Veri alma hatası:', error);
        mapDiv.innerHTML = 'Veriler yüklenemedi.';
    }
}

function displayActivityStats(activity, streams) {
    const statsDiv = document.getElementById('activityStats');
    
    // Ortalama kadans hesapla (eğer varsa)
    const avgCadence = streams.cadence?.data ? 
        Math.round(streams.cadence.data.reduce((a, b) => a + b, 0) / streams.cadence.data.length) : 
        null;

    // Maksimum eğim
    const maxGrade = streams.grade_smooth?.data ?
        Math.max(...streams.grade_smooth.data).toFixed(1) :
        null;

    // Toplam tırmanış (yükseklik farkları)
    let totalAscent = 0;
    if (streams.altitude?.data) {
        for (let i = 1; i < streams.altitude.data.length; i++) {
            const diff = streams.altitude.data[i] - streams.altitude.data[i-1];
            if (diff > 0) totalAscent += diff;
        }
    }

    statsDiv.innerHTML = `
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">Mesafe</div>
            <div class="text-lg font-semibold">${(activity.distance / 1000).toFixed(2)} km</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">Süre</div>
            <div class="text-lg font-semibold">${new Date(activity.moving_time * 1000).toISOString().substr(11, 8)}</div>
        </div>
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">Ortalama Hız</div>
            <div class="text-lg font-semibold">${(activity.average_speed * 3.6).toFixed(1)} km/s</div>
        </div>
        ${avgCadence ? `
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">Ortalama Kadans</div>
            <div class="text-lg font-semibold">${avgCadence} rpm</div>
        </div>
        ` : ''}
        ${maxGrade ? `
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">Maksimum Eğim</div>
            <div class="text-lg font-semibold">%${maxGrade}</div>
        </div>
        ` : ''}
        ${totalAscent ? `
        <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-500">Toplam Tırmanış</div>
            <div class="text-lg font-semibold">${Math.round(totalAscent)}m</div>
        </div>
        ` : ''}
    `;
}

function initializeEnhancedMap(container, activity, streams) {
    if (window.currentMap) {
        window.currentMap.remove();
    }

    // Haritayı başlat
    window.currentMap = L.map(container);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(window.currentMap);

    // Info panel oluştur
    const infoPanel = L.control({position: 'bottomleft'});
    infoPanel.onAdd = function() {
        const div = L.DomUtil.create('div', 'info bg-white p-2 rounded shadow');
        div.innerHTML = '<b>Fare ile rotanın üzerine gelin</b>';
        return div;
    };
    infoPanel.addTo(window.currentMap);

    // Rota noktalarını hazırla
    const points = streams.latlng.data.map((coord, i) => ({
        latlng: L.latLng(coord[0], coord[1]),
        altitude: streams.altitude?.data[i],
        cadence: streams.cadence?.data[i],
        grade: streams.grade_smooth?.data[i]
    }));

    // Rota segmentlerini oluştur
    for (let i = 0; i < points.length - 1; i++) {
        const segment = L.polyline([points[i].latlng, points[i + 1].latlng], {
            color: getSegmentColor(points[i].grade || 0),
            weight: 4
        }).addTo(window.currentMap);

        // Mouse over olayı
        segment.on('mouseover', (e) => {
            segment.setStyle({weight: 6});
            updateInfoPanel(points[i]);
        });

        segment.on('mouseout', (e) => {
            segment.setStyle({weight: 4});
        });
    }

    // Haritayı rota sınırlarına göre ayarla
    window.currentMap.fitBounds(L.latLngBounds(points.map(p => p.latlng)));

    // Eğim ölçeği ekle
    addGradeLegend(window.currentMap);
}

function getSegmentColor(grade) {
    // Eğime göre renk döndür (kırmızı: yokuş yukarı, yeşil: düz, mavi: yokuş aşağı)
    if (grade > 3) return `hsl(0, 100%, ${100 - Math.min(grade * 5, 50)}%)`; // kırmızı
    if (grade < -3) return `hsl(240, 100%, ${100 - Math.min(Math.abs(grade) * 5, 50)}%)`; // mavi
    return `hsl(120, 70%, 50%)`; // yeşil
}

function updateInfoPanel(point) {
    const info = document.querySelector('.info');
    info.innerHTML = `
        <div class="text-sm">
            ${point.altitude ? `<div>Yükseklik: ${Math.round(point.altitude)}m</div>` : ''}
            ${point.cadence ? `<div>Kadans: ${Math.round(point.cadence)} rpm</div>` : ''}
            ${point.grade ? `<div>Eğim: %${point.grade.toFixed(1)}</div>` : ''}
        </div>
    `;
}

function addGradeLegend(map) {
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend bg-white p-2 rounded shadow');
        div.innerHTML = `
            <div class="text-sm font-semibold mb-1">Eğim</div>
            <div class="flex items-center">
                <div style="background: linear-gradient(to bottom, hsl(0,100%,50%), hsl(120,70%,50%), hsl(240,100%,50%)); width: 20px; height: 100px;"></div>
                <div class="ml-2 text-xs">
                    <div>>3%</div>
                    <div>0%</div>
                    <div><-3%</div>
                </div>
            </div>
        `;
        return div;
    };
    legend.addTo(map);
}
